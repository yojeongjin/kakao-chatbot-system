# íŒŒí”„ë´‡ - ì¹´ì¹´ì˜¤ ì±—ë´‡ ê¸°ë°˜ ê³ ê° ì‘ëŒ€ ìë™í™” ì‹œìŠ¤í…œ

> **íŒŒí”„ë´‡**ì€ ì£¼ì°¨ ì„œë¹„ìŠ¤ì˜ ì˜ˆì•½ í™•ì¸/ì·¨ì†Œ ë° í™˜ë¶ˆ ì ‘ìˆ˜ë¥¼ **ì¹´ì¹´ì˜¤ ì±—ë´‡ ê¸°ë°˜ìœ¼ë¡œ ìë™í™”**í•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.  
> ì‚¬ìš©ì í¸ì˜ì„±ê³¼ CS íš¨ìœ¨í™”ë¥¼ ìœ„í•´ ì±—ë´‡ì„ í†µí•´ ì˜ˆì•½ì¡°íšŒë¶€í„° ì¦ë¹™ìë£Œ ì—…ë¡œë“œê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

#### ğŸ’¡ ì´ í”„ë¡œì íŠ¸ëŠ” ì‹¤ì œ ì„œë¹„ìŠ¤ì— ì ìš©ëœ ì½”ë“œ ì¤‘ `ì¼ë¶€ë§Œ ë°œì·Œí•˜ì—¬ êµ¬ì„±ëœ ì˜ˆì‹œìš© ì½”ë“œ`ì…ë‹ˆë‹¤.

---

### í”Œë¡œìš°ì°¨íŠ¸

![flowchart](./assets/chatbot-flow.png)

---

### ê¸°ìˆ  ìŠ¤íƒ

| í•­ëª©          | ì‚¬ìš© ê¸°ìˆ                                          |
| ------------- | ------------------------------------------------- |
| Backend       | Node.js, Express                                  |
| DB            | MySQL                                             |
| ì˜ˆì•½ ìŠ¤ì¼€ì¤„ëŸ¬ | node-schedule                                     |
| ì±—ë´‡ í…œí”Œë¦¿   | Kakao i ì˜¤í”ˆë¹Œë” (TextCard, ItemCard, Carousel)   |
| ìš´ì˜í™˜ê²½      | NHN Cloud Linux ì¸ìŠ¤í„´ìŠ¤ (PM2 ê¸°ë°˜ í”„ë¡œì„¸ìŠ¤ ìš´ì˜) |

---

### ì£¼ìš”ê¸°ëŠ¥

- ì¹´ì¹´ì˜¤ i ì˜¤í”ˆë¹Œë” ì—°ë™í•˜ì—¬ **ì˜ˆì•½ ì¡°íšŒ, ì˜ˆì•½ ì·¨ì†Œ, í™˜ë¶ˆ ìš”ì²­ ë“± ì±—ë´‡ ë¸”ë¡ ê¸°ë°˜ íë¦„ ì œì–´**
- ì‚¬ìš©ì ì…ë ¥ê°’ ë˜ëŠ” í™˜ë¶ˆ ì •ì±… ë“±ì— ë”°ë¥¸ **ë™ì  ì‘ë‹µ ë° ìë™ ë¶„ê¸° ì²˜ë¦¬**
- **ì‚¬ì§„(í™˜ë¶ˆ ì¦ë¹™ìë£Œ) ë¦¬ì‚¬ì´ì§•** í›„ ì„œë²„ ì €ì¥ ë° 1ê°œì›” í›„ **ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„ëŸ¬** êµ¬í˜„

```
ğŸ“ kakao-chatbot-system/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ buttons.js       # ë¸”ë¡ ë²„íŠ¼ í…œí”Œë¦¿
â”‚   â””â”€â”€ templates.js     # ì¹´ì¹´ì˜¤ ì‘ë‹µ í…œí”Œë¦¿ (TextCard, Carousel ë“±)
â”œâ”€â”€ public/
â”‚   â””â”€â”€ images/          # ì—…ë¡œë“œ ì´ë¯¸ì§€ ì €ì¥ ê²½ë¡œ
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ agreement/       # ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜
â”‚   â”œâ”€â”€ inquiry/         # ì˜ˆì•½ ì¡°íšŒ
â”‚   â”œâ”€â”€ cancel/          # ì˜ˆì•½ ì·¨ì†Œ ì•ˆë‚´
â”‚   â”œâ”€â”€ photo/           # ì‚¬ì§„ ì—…ë¡œë“œ ë° í™˜ë¶ˆ ì ‘ìˆ˜
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ imageCleanup.js  # ì´ë¯¸ì§€ ìë™ ì‚­ì œ ë¡œì§
â”‚   â””â”€â”€ index.js         # node-schedule ë“±ë¡
â”œâ”€â”€ app.js               # ì„œë²„ ì‹¤í–‰ ë° ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡
â””â”€â”€ package.json
```

#### 1. ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜ (agreement)

- í…ìŠ¤íŠ¸ ì¹´ë“œë¡œ ì´ìš©ì•½ê´€ ì•ˆë‚´ ë° ë¸”ë¡ ì´ë™ ì„ íƒ

#### 2. ì˜ˆì•½ ì¡°íšŒ (inquiry)

- `ì°¨ëŸ‰ë²ˆí˜¸ + íœ´ëŒ€í°ë²ˆí˜¸` ê¸°ë°˜ ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ
- ì˜ˆì•½ í•­ëª©ì— ë”°ë¼ "ì˜ˆì•½ ì·¨ì†Œ" ë¸”ë¡ìœ¼ë¡œ ì´ë™ ê°€ëŠ¥

```json
// Request Body (ì±—ë´‡ êµ¬ì¡° ê¸°ë°˜)
{
  "action": {
    "detailParams": {
      "car_no": { "origin": "123ê°€4567" },
      "phone_no": { "origin": "01012345678" }
    }
  }
}
```

```json
// ì‘ë‹µ (ì˜ˆì•½ ì •ë³´ ìˆìŒ)
{
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "carousel": {  // ìºëŸ¬ì…€ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
          "type": "itemCard",
          "items": [
            {
              "imageTitle": { "title": "xxxì£¼ì°¨ì¥", "description": "ì‹œê°„ê¶Œ" },
              "itemList": [...],
              "buttons": [
                {
                  "action": "block",
                  "label": "ì˜ˆì•½ ì·¨ì†Œ",
                  "blockId": "xxxx",
                  "extra": { ... }
                }
              ]
            }
          ]
        }
      }
    ]
  }
}
```

```json
// ì‘ë‹µ (ì˜ˆì•½ ì •ë³´ ì—†ìŒ)
{
  "template": {
    "outputs": [
      {
        "textCard": {
          "title": "ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.",
          "buttons": [
            { "label": "ë‹¤ì‹œ ì¡°íšŒí•˜ê¸°", "blockId": "xxxx" },
            { "label": "ì²˜ìŒìœ¼ë¡œ", "blockId": "xxxx" }
          ]
        }
      }
    ]
  }
}
```

#### 3. ì˜ˆì•½ ì·¨ì†Œ ë¶„ê¸° (cancel)

- ì˜ˆì•½ ë‚ ì§œ ë° ì‹œê°„ ê¸°ë°˜ ì·¨ì†Œ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨
- ì·¨ì†Œ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° "í™˜ë¶ˆ ì ‘ìˆ˜" ë¸”ë¡ ì—°ê²°
- **_ì·¨ì†Œ ê°€ëŠ¥ ì‹œ í™˜ë¶ˆ ì˜ˆì • ê¸ˆì•¡/í¬ì¸íŠ¸ ê³„ì‚°_**

---

```
ì·¨ì†Œ ê°€ëŠ¥ ì¡°ê±´: 1)ì˜¤ëŠ˜ì´ ì˜ˆì•½ì¼ì´ê³  2) í˜„ì¬ ì‹œê°ì´ 'ì˜ˆì•½ì‹œê°„ ì´ì „'
```

```json
// 1. ì·¨ì†Œ ê°€ëŠ¥ ì‘ë‹µ
{
  "textCard": {
    "title": "ìœ„ ì˜ˆì•½ì„ ì·¨ì†Œí•´ë“œë¦´ê¹Œìš”?",
    "description": "â€¢ í™˜ë¶ˆì˜ˆì •ê¸ˆì•¡ : 4,000 ì› â€¢ í™˜ë¶ˆì˜ˆì •í¬ì¸íŠ¸ : 800 í¬ì¸íŠ¸",
    "buttons": [
      {
        "label": "ë„¤, ì·¨ì†Œí•©ë‹ˆë‹¤.",
        "blockId": "xxxx",
        "extra": {
          "...": "ì˜ˆì•½ ì •ë³´ + reason í¬í•¨"
        }
      },
      { "label": "ì•„ë‹ˆì˜¤, ì±—ë´‡ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.", "blockId": "xxx" }
    ]
  }
}
```

```json
// 2. ë‹¹ì¼ì´ì§€ë§Œ ì·¨ì†Œ ë¶ˆê°€
{
  "textCard": {
    "title": "ì´ìš© ì‹œì‘ ì‹œê°„ì´ ì´ˆê³¼í•˜ì—¬ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.",
    "description": "ë¶€ì •ì£¼ì°¨ ë˜ëŠ” ê³µì‚¬ì¤‘ìœ¼ë¡œ ì¸í•´ ì£¼ì°¨ê°€ ì–´ë ¤ìš´ ìƒí™©ì´ì‹œë©´ í™˜ë¶ˆ ì ‘ìˆ˜ë¥¼ ë„ì™€ë“œë¦´ê²Œìš”!",
    "buttons": [
      { "label": "í™˜ë¶ˆ ì ‘ìˆ˜", "blockId": "xxx" },
      { "label": "ë‹¤ì‹œ ì¡°íšŒí•˜ê¸°", "blockId": "xxx" }
    ]
  }
}
```

```json
// 3. ì·¨ì†Œë¶ˆê°€ - ì˜ˆì•½ ë‹¹ì¼ ì•„ë‹˜
{
  "textCard": {
    "title": "ì˜ˆì•½ ë‹¹ì¼ì—ë§Œ ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
    "buttons": [
      { "label": "ë‹¤ì‹œ ì¡°íšŒí•˜ê¸°", "blockId": "xxx" },
      { "label": "ì²˜ìŒìœ¼ë¡œ", "blockId": "xxx" }
    ]
  }
}
```

#### 4. ì‚¬ì§„ ì—…ë¡œë“œ ë° í™˜ë¶ˆ ì ‘ìˆ˜ (photo)

- ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ URL ë‹¤ìš´ë¡œë“œ
- `sharp` ë¼ì´ë¸ŒëŸ¬ë¦¬ ê¸°ë°˜ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•/ì••ì¶• í›„ ì„œë²„ ì €ì¥
- DBì— í™˜ë¶ˆ ìš”ì²­ ì •ë³´ ë° ì´ë¯¸ì§€ URI ì €ì¥

| ë‹¨ê³„                    | ì„¤ëª…                                                         |
| ----------------------- | ------------------------------------------------------------ |
| 1) ì´ë¯¸ì§€ URL ìˆ˜ì‹       | ì¹´ì¹´ì˜¤ ì±—ë´‡ì—ì„œ ë°›ì€ base64 ì´ë¯¸ì§€ or ì¹´ì¹´ì˜¤ URL             |
| 2) ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ      | `axios`ë¡œ ìŠ¤íŠ¸ë¦¬ë° ë‹¤ìš´ë¡œë“œ                                  |
| 3) ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•/ì••ì¶• | `sharp` ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© â†’ `width 680px`, `jpeg(30% quality)` |
| 4) íŒŒì¼ ì €ì¥            | `/public/images/YYYYMMDD_second_uuid.jpeg` í˜•ì‹              |
| 5) DB ì €ì¥              | `refund` í…Œì´ë¸”ì— order_id, reason, image URI ë“± ê¸°ë¡        |

```js
const transformer = sharp()
  .resize({ width: 680 }) // ë„ˆë¹„ 680pxë¡œ ë¦¬ì‚¬ì´ì§•
  .jpeg({ quality: 30 }); // JPEG í’ˆì§ˆ 30%ë¡œ ì••ì¶•

response.data
  .pipe(transformer) // ì´ë¯¸ì§€ ìŠ¤íŠ¸ë¦¼ì— ë¦¬ì‚¬ì´ì§• ì ìš©
  .pipe(fs.createWriteStream(savePath)); // ì„œë²„ì— ì €ì¥
```

#### 5. ì´ë¯¸ì§€ ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„ëŸ¬ (scheduler)

- ì €ì¥ëœ ì´ë¯¸ì§€ íŒŒì¼ì˜ íŒŒì¼ëª…ì—ì„œ ë‚ ì§œë¥¼ ì¶”ì¶œ
- ì„œë²„ ë¦¬ì†ŒìŠ¤ ëˆ„ì  ë°©ì§€ë¥¼ ìœ„í•´ ìƒì„±ì¼ ê¸°ì¤€ 1ê°œì›”ì´ ì§€ë‚œ ì´ë¯¸ì§€ ìë™ ì‚­ì œ
- `node-schedule`ì„ í™œìš©í•˜ì—¬ ë§¤ì¼ ìƒˆë²½ 3ì‹œì— ì‹¤í–‰

**\*ì£¼ìš” ì²˜ë¦¬ ë°©ì‹**
| í•­ëª© | ë‚´ìš© |
|------|------|
| ì‚­ì œ ëŒ€ìƒ | `public/images/` ë‚´ `YYYYMMDD_second_uuid.jpeg` í˜•ì‹ì˜ íŒŒì¼ |
| ê¸°ì¤€ ë‚ ì§œ | íŒŒì¼ëª…ì—ì„œ ì¶”ì¶œí•œ ë‚ ì§œ (`YYYYMMDD`) |
| ë³´ê´€ ê¸°ê°„ | **30ì¼(1ê°œì›”)** ìœ ì§€ í›„ ì‚­ì œ |
| ì‹¤í–‰ ì£¼ê¸° | ë§¤ì¼ ìƒˆë²½ 3ì‹œ |
| ë¼ì´ë¸ŒëŸ¬ë¦¬ | `node-schedule` ì‚¬ìš©

**\*ì‚­ì œ ë¡œì§ ìš”ì•½(imageCleanup.js)**

```js
// íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ: YYYYMMDD_*
const match = file.match(/^(\d{8})_\d+_/);

const fileDate = new Date(
  Number(dateStr.slice(0, 4)), // ì—°ë„
  Number(dateStr.slice(4, 6)) - 1, // ì›”
  Number(dateStr.slice(6, 8)) // ì¼
);

const age = now - fileDate.getTime();
if (age > ONE_MONTH_IN_MS) {
  fs.unlink(filePath); // 30ì¼ ì´ìƒ ê²½ê³¼ ì‹œ ì‚­ì œ
}
```

**\*ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡**

```js
const schedule = require('node-schedule');
const { imageCleanup } = require('./imageCleanup');

schedule.scheduleJob('0 3 * * *', () => {
  imageCleanup(); // ë§¤ì¼ ìƒˆë²½ 3ì‹œì— ì‹¤í–‰
});
```
